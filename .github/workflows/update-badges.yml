name: Update Repository Badges
permissions:
  contents: write

on:
  workflow_dispatch: # Manually triggered
  schedule:
    - cron: '0 0 * * 0' # Run weekly on Sunday at midnight

jobs:
  update-badges:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch repository statistics
        id: stats
        run: |
          # Get repository data
          response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/Admonstrator/paperless-ai-patched")

          stars=$(echo "$response" | jq -r '.stargazers_count')
          forks=$(echo "$response" | jq -r '.forks_count')

          # Get latest release
          release_response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/Admonstrator/paperless-ai-patched/releases/latest")

          latest_release=$(echo "$release_response" | jq -r '.tag_name // "N/A"')

          # Get Docker Hub pull count
          docker_response=$(curl -s "https://hub.docker.com/v2/repositories/admonstrator/paperless-ai-patched/")
          docker_pulls=$(echo "$docker_response" | jq -r '.pull_count // 0')

          echo "stars=$stars" >> $GITHUB_OUTPUT
          echo "forks=$forks" >> $GITHUB_OUTPUT
          echo "release=$latest_release" >> $GITHUB_OUTPUT
          echo "docker_pulls=$docker_pulls" >> $GITHUB_OUTPUT

          echo "âœ… Fetched stats: $stars stars, $forks forks, release $latest_release, docker pulls $docker_pulls"

      - name: Generate README from template
        run: |
          # Helper function to determine badge color based on count
          get_color() {
            local count=$1
            if [ "$count" -ge 300 ]; then echo "brightgreen"
            elif [ "$count" -ge 100 ]; then echo "green"
            elif [ "$count" -ge 50 ]; then echo "yellowgreen"
            elif [ "$count" -ge 10 ]; then echo "yellow"
            else echo "orange"
            fi
          }

          # Helper to format large numbers (e.g. 1200 â†’ 1.2k)
          format_number() {
            local n=$1
            if [ "$n" -ge 1000000 ]; then
              echo "$(awk "BEGIN {printf \"%.1fM\", $n/1000000}")"
            elif [ "$n" -ge 1000 ]; then
              echo "$(awk "BEGIN {printf \"%.1fk\", $n/1000}")"
            else
              echo "$n"
            fi
          }

          stars="${{ steps.stats.outputs.stars }}"
          forks="${{ steps.stats.outputs.forks }}"
          release="${{ steps.stats.outputs.release }}"
          docker_pulls="${{ steps.stats.outputs.docker_pulls }}"
          stars_color=$(get_color $stars)
          docker_color=$(get_color $docker_pulls)
          docker_pulls_fmt=$(format_number $docker_pulls)

          # Escape dashes for shields.io badge URLs (single dash â†’ double dash)
          release_badge="${release//-/--}"

          # Get current date
          update_date=$(date '+%Y-%m-%d')

          # Copy template to README.md
          cp readme.template.md README.md

          # Replace {{VERSION}} placeholder
          sed -i "s|{{VERSION}}|${release}|g" README.md

          # Replace dynamic GitHub release badge with static badge
          sed -i "s|https://img.shields.io/github/v/release/Admonstrator/paperless-ai-patched?style=for-the-badge\&logo=github\&color=blue|https://img.shields.io/badge/release-${release_badge}-blue?style=for-the-badge\&logo=github|g" README.md

          # Replace dynamic GitHub stars badge with static badge
          sed -i "s|https://img.shields.io/github/stars/Admonstrator/paperless-ai-patched?style=for-the-badge|https://img.shields.io/badge/stars-${stars}-${stars_color}?style=for-the-badge\&logo=github|g" README.md

          # Replace dynamic Docker pulls badge with static badge
          sed -i "s|https://img.shields.io/docker/pulls/admonstrator/paperless-ai-patched?style=for-the-badge\&logo=docker|https://img.shields.io/badge/docker%20pulls-${docker_pulls_fmt}-${docker_color}?style=for-the-badge\&logo=docker|g" README.md

          # Add last updated footer
          echo "" >> README.md
          echo "<div align=\"center\">" >> README.md
          echo "" >> README.md
          echo "_Last updated: ${update_date}_" >> README.md
          echo "" >> README.md
          echo "</div>" >> README.md

          echo "âœ… README generated with static badges successfully"

      - name: Check for changes
        id: check_changes
        run: |
          git add README.md
          if git diff --cached --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -m "ðŸ¤– Update repository badges [automated]"
          git push

      - name: Create summary
        run: |
          echo "## ðŸ“Š Badge Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Repository Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- â­ Stars: ${{ steps.stats.outputs.stars }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ´ Forks: ${{ steps.stats.outputs.forks }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Latest Release: ${{ steps.stats.outputs.release }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ³ Docker Pulls: ${{ steps.stats.outputs.docker_pulls }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "âœ… **README.md was updated with new badge values**" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No changes detected - badges are up to date**" >> $GITHUB_STEP_SUMMARY
          fi
